services:
  redis-7001:
    image: redis:7-alpine
    container_name: redis-7001
    command: >
      redis-server
      --port 7001
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
    ports: ["7001:7001"]
    volumes: ["redis-7001:/data"]

  redis-7002:
    image: redis:7-alpine
    container_name: redis-7002
    command: >
      redis-server
      --port 7002
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
    ports: ["7002:7002"]
    volumes: ["redis-7002:/data"]

  redis-7003:
    image: redis:7-alpine
    container_name: redis-7003
    command: >
      redis-server
      --port 7003
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
    ports: ["7003:7003"]
    volumes: ["redis-7003:/data"]

  redis-7004:
    image: redis:7-alpine
    container_name: redis-7004
    command: >
      redis-server
      --port 7004
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
    ports: ["7004:7004"]
    volumes: ["redis-7004:/data"]

  redis-7005:
    image: redis:7-alpine
    container_name: redis-7005
    command: >
      redis-server
      --port 7005
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
    ports: ["7005:7005"]
    volumes: ["redis-7005:/data"]

  redis-7006:
    image: redis:7-alpine
    container_name: redis-7006
    command: >
      redis-server
      --port 7006
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --masterauth ${REDIS_PASSWORD}
    ports: ["7006:7006"]
    volumes: ["redis-7006:/data"]

  cluster-init:
    image: redis:7-alpine
    container_name: redis-cluster-init
    depends_on:
      - redis-7001
      - redis-7002
      - redis-7003
      - redis-7004
      - redis-7005
      - redis-7006
    entrypoint: >
      sh -c "
      sleep 10 &&
      redis-cli -a ${REDIS_PASSWORD} --cluster create
      redis-7001:7001 redis-7002:7002 redis-7003:7003
      redis-7004:7004 redis-7005:7005 redis-7006:7006
      --cluster-replicas 1 --cluster-yes
      "
    restart: "no"

volumes:
  redis-7001:
  redis-7002:
  redis-7003:
  redis-7004:
  redis-7005:
  redis-7006:
